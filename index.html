<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Outil TT Alimentation</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f7f7f7; color: #333; }
    .header { text-align: center; margin-bottom: 20px; }
    .header img { max-height: 60px; vertical-align: middle; }
    .header h1 { display: inline-block; margin: 0 0 0 10px; font-size: 32px; vertical-align: middle; }
    .table-container { overflow-x: auto; background: #fff; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
    th { background: #f0f0f0; }
    input[type=text], select { width: 100%; box-sizing: border-box; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase; }
    .controls { margin: 15px 0; display: flex; gap: 10px; }
    .controls button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: #fff; }
    #addRow { background: #4CAF50; }
    #saveCSV { background: #2196F3; }
    #reset { background: #f44336; }
    .error { border: 2px solid red !important; }
  </style>
</head>
<body>

  <div class="header">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSn8j7-SXb8p7I8_p3zcqPpfI2plrpABlD4eGw73IYdUsjfdx4dsN2VrXGv4oc6ZTgtcyQ&usqp=CAU" alt="Logo">
    <h1>Outil TT Alimentation</h1>
  </div>

  <div class="controls">
    <button id="addRow">Ajouter ligne</button>
    <button id="reset">Effacer tout</button>
    <button id="saveCSV">Télécharger CSV</button>
  </div>

  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr>
          <th>NUMERO_REFERENCE</th>
          <th>FIRME</th>
          <th>MATRICULE</th>
          <th>NOM</th>
          <th>PRENOM</th>
          <th>SEXE</th>
          <th>DDN</th>
          <th>EMPLOI</th>
          <th>ADRESSE</th>
          <th>APP</th>
          <th>MOIS</th>
          <th>VILLE</th>
          <th>CODE_POSTAL</th>
          <th>NUMERO_PERMIS</th>
          <th>NOTES</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <script>
    const tbody = document.querySelector('#dataTable tbody');

    const moisOptions = [
      '', 
      '01- JANVIER',
      '02- FÉVRIER',
      '03- MARS',
      '04- AVRIL',
      '05- MAI',
      '06- JUIN',
      '07- JUILLET',
      '08- AOÛT',
      '09- SEPTEMBRE',
      '10- OCTOBRE',
      '11- NOVEMBRE',
      '12- DÉCEMBRE'
    ].map(m => `<option value="${m}">${m}</option>`).join('');

    function newRow() {
      const idx = tbody.rows.length;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" name="ref${idx}"></td>
        <td><input type="text" name="firme${idx}"></td>
        <td><input type="text" name="matricule${idx}"></td>
        <td><input type="text" name="nom${idx}"></td>
        <td><input type="text" name="prenom${idx}"></td>
        <td>
          <select name="sexe${idx}">
            <option value=""></option>
            <option value="M">M</option>
            <option value="F">F</option>
            <option value="X">X</option>
          </select>
        </td>
        <td><input type="text" name="ddn${idx}" placeholder="YYYY-MM-DD"></td>
        <td><input type="text" name="emploi${idx}"></td>
        <td><input type="text" name="adresse${idx}"></td>
        <td><input type="text" name="app${idx}"></td>
        <td>
          <select name="mois${idx}">
            ${moisOptions}
          </select>
        </td>
        <td><input type="text" name="ville${idx}"></td>
        <td><input type="text" name="cp${idx}" placeholder="A1A 1A1"></td>
        <td><input type="text" name="permis${idx}"></td>
        <td><input type="text" name="notes${idx}"></td>
      `;
      tbody.appendChild(tr);
    }

    document.getElementById('addRow').addEventListener('click', newRow);
    document.getElementById('reset').addEventListener('click', () => {
      tbody.innerHTML = '';
    });

    function formatCP(v) {
      v = v.toUpperCase().replace(/\s+/g,'');
      if (v.length > 3) v = v.slice(0,3) + ' ' + v.slice(3);
      return v.slice(0,7);
    }

    document.addEventListener('input', e => {
      if (e.target.name.startsWith('cp')) {
        e.target.value = formatCP(e.target.value);
      }
      if (e.target.tagName === 'INPUT' && e.target.type === 'text') {
        e.target.value = e.target.value.toUpperCase();
      }
    });

    document.getElementById('saveCSV').addEventListener('click', () => {
      const rows = [];
      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const ts = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;

      for (let i = 0; i < tbody.rows.length; i++) {
        const get = name => {
          const el = document.getElementsByName(name + i)[0];
          return el ? el.value.trim() : '';
        };
        const row = {
          ref: get('ref'),
          firme: get('firme'),
          matricule: get('matricule'),
          nom: get('nom'),
          prenom: get('prenom'),
          sexe: get('sexe'),
          ddn: get('ddn'),
          emploi: get('emploi'),
          adresse: get('adresse'),
          app: get('app'),
          mois: get('mois'),
          ville: get('ville'),
          code_postal: formatCP(get('cp')),
          permis: get('permis'),
          notes: get('notes')
        };
        // Skip completely empty rows
        if (Object.values(row).every(v => v === '')) continue;
        rows.push(row);
      }

      if (rows.length === 0) {
        alert('Aucune donnée à exporter.');
        return;
      }

      const headers = [
        'NUMERO_REFERENCE',
        'FIRME',
        'MATRICULE',
        'NOM',
        'PRENOM',
        'SEXE',
        'DDN',
        'EMPLOI',
        'ADRESSE',
        'APP',
        'MOIS',
        'VILLE',
        'CODE_POSTAL',
        'NUMERO_PERMIS',
        'NOTES'
      ];

      let csv = headers.join(';') + '\n';
      rows.forEach(r => {
        csv += [
          r.ref,
          r.firme,
          r.matricule,
          r.nom,
          r.prenom,
          r.sexe,
          r.ddn,
          r.emploi,
          r.adresse,
          r.app,
          r.mois,
          r.ville,
          r.code_postal,
          r.permis,
          r.notes
        ].join(';') + '\n';
      });

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=windows-1252;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `export_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('CSV téléchargé.');
    });

    // ligne initiale
    newRow();
  </script>
</body>
</html>
