<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Outil TT Alimentation - Login</title>
  <style>
    /* =========================
       STYLES GLOBAUX / LOGIN
    ========================= */
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f7f7f7;color:#333;}
    #login-page{
      position:fixed;top:0;left:0;right:0;bottom:0;background:#fff;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      z-index:1000;opacity:1;transition:opacity 1s ease;
    }
    #login-page.fade-out{opacity:0;}
    #login-page .login-container{
      text-align:center;border:1px solid #ccc;padding:30px;border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,.2);background:#fff;
    }
    #login-page img{max-height:80px;margin-bottom:20px;}
    #login-page input[type=password]{
      padding:10px;font-size:16px;width:250px;border:1px solid #ccc;
      border-radius:4px;margin-bottom:20px;
    }
    #login-page button{
      padding:10px 20px;font-size:16px;border:none;border-radius:4px;
      background:#4CAF50;color:#fff;cursor:pointer;
    }

    /* =========================
       INTERFACE PRINCIPALE
    ========================= */
    #main-page{display:none;padding:20px;max-width:1900px;margin:auto;}
    .header-container{display:flex;align-items:center;margin-bottom:20px;}
    .header-logo{max-height:60px;margin-right:10px;}
    .header-title{font-size:32px;margin:0;}
    .section{
      margin-bottom:20px;background:#fff;padding:15px;border-radius:6px;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    label{display:block;margin-bottom:5px;font-weight:bold;}
    input[type=text],select{
      padding:6px;margin-bottom:10px;box-sizing:border-box;
      border:1px solid #ccc;border-radius:4px;
    }
    input[type=text]{text-transform:uppercase;}

    #clearClient{
      margin-top:5px;padding:5px 10px;font-size:14px;border:none;border-radius:4px;
      background:#f44336;color:#fff;cursor:pointer;
    }
    #clientSelection{
      display:flex;align-items:flex-start;gap:5px;margin-bottom:10px;
    }
    .client-info{flex:1;}
    .client-options{display:flex;flex-direction:column;gap:5px;}
    .print-label{font-size:16px;display:flex;align-items:center;}
    .print-label input{margin-right:5px;}
    .client-buttons{display:flex;gap:5px;}

    .table-container{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;background:#fff;}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;}

    /* Cacher colonne VILLE par défaut */
    #defaultTableContainer th:nth-child(11),
    #defaultTableContainer td:nth-child(11){display:none;}

    .button-container{display:flex;justify-content:flex-end;align-items:center;margin-top:10px;gap:10px;}
    button{padding:10px 15px;border:none;border-radius:4px;background:#4CAF50;color:#fff;cursor:pointer;}
    #addRow{background:blue;}
    #resetButton{background:#f44336;}
    .error{border:2px solid red !important;background:#fdd;}
    #modeCompagnieContainer{margin-bottom:15px;display:none;}
  </style>
</head>
<body>

  <!-- ======================= LOGIN ======================= -->
  <div id="login-page">
    <div class="login-container">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSn8j7-SXb8p7I8_p3zcqPpfI2plrpABlD4eGw73IYdUsjfdx4dsN2VrXGv4oc6ZTgtcyQ&usqp=CAU" alt="Logo">
      <h2>Bienvenue</h2>
      <input type="password" id="password" placeholder="Mot de passe">
      <br>
      <button id="loginButton">Se connecter</button>
    </div>
  </div>

  <!-- ======================= INTERFACE ==================== -->
  <div id="main-page">
    <div class="header-container">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSn8j7-SXb8p7I8_p3zcqPpfI2plrpABlD4eGw73IYdUsjfdx4dsN2VrXGv4oc6ZTgtcyQ&usqp=CAU" alt="Logo" class="header-logo">
      <h1 class="header-title">Outil TT Alimentation</h1>
    </div>

    <!-- Sélection client -->
    <div class="section" id="clientSelection">
      <div class="client-info">
        <label for="clientInput">Sélectionner le client (numéro et/ou nom) :</label>
        <input type="text" id="clientInput" list="clientList" placeholder="Ex. 2419 - Curateur public du Québec">
        <datalist id="clientList"></datalist>
        <button type="button" id="clearClient">Désélectionner le client</button>
      </div>
      <div class="client-options">
        <label class="print-label"><input type="checkbox" id="printOption" checked> Imprimer le CSV</label>
        <div class="client-buttons">
          <button type="button" id="set1Row">1&nbsp;ligne</button>
          <button type="button" id="set5Rows">5&nbsp;lignes</button>
          <button type="button" id="set10Rows">10&nbsp;lignes</button>
        </div>
      </div>
    </div>

    <!-- Mode Compagnie -->
    <div class="section" id="modeCompagnieContainer">
      <label><input type="checkbox" id="modeCompagnie"> CSV Compagnie</label>
    </div>

    <!-- Formulaire -->
    <div class="section">
      <form id="data-form">
        <!-- Tableau par défaut -->
        <div class="table-container" id="defaultTableContainer">
          <table>
            <thead>
              <tr>
                <th>REFERENCE</th><th>NOM</th><th>PRENOM</th><th>SEXE</th>
                <th>ANNÉE</th><th>MOIS</th><th>JOUR</th><th>EMPLOI</th>
                <th>ADRESSE</th><th>APP</th><th>VILLE</th><th>POSTAL</th>
                <th>PERMIS</th><th>NOTES</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Tableau Compagnie (mis à jour) -->
        <div class="table-container" id="compagnieTableContainer" style="display:none;">
          <table>
            <thead>
              <tr>
                <th>REFERENCE</th><th>FIRME</th><th>MATRICULE</th>
                <th>NOM</th><th>PRENOM</th><th>SEXE</th><th>DDN</th>
                <th>EMPLOI</th><th>ADRESSE</th><th>APP</th>
                <th>VILLE</th><th>POSTAL</th><th>PERMIS</th><th>NOTES</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Boutons -->
        <div class="button-container">
          <button type="button" id="addRow">Ajouter ligne</button>
          <button type="reset"  id="resetButton">Effacer tout</button>
          <button type="button" id="saveButton">Télécharger CSV</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ======================= SCRIPT ======================= -->
  <script>
    /* 1) LOGIN */
    const pwdInput = document.getElementById("password"),
          loginBtn  = document.getElementById("loginButton");
    pwdInput.addEventListener("keyup", e => { if(e.key==="Enter") tryLogin(); });
    loginBtn.addEventListener("click", tryLogin);
    function tryLogin(){
      if(pwdInput.value==="Alim7420"){
        document.getElementById("login-page").classList.add("fade-out");
        setTimeout(()=>{
          document.getElementById("login-page").style.display="none";
          document.getElementById("main-page").style.display="block";
          fetch("fichier_client(in).csv")
            .then(r=>r.text()).then(parseClientCSV)
            .catch(err=>console.error("Erreur CSV client :",err));
        },1000);
      } else alert("Mot de passe incorrect.");
    }

    /* 2) VARIABLES GLOBALES */
    let clients={}, selectedClient=null;
    let defaultRowCount=10, compagnieRowCount=10;

    /* 3) CHARGEMENT CLIENTS */
    function parseClientCSV(csv){
      const lines=csv.split(/\r?\n/);
      if(lines.length<2) return;
      const headers=lines[0].split(";"),
            idxClient=headers.indexOf("Client"),
            idxName  =headers.indexOf("Nom client"),
            idxEmp   =idxName+1;
      for(let i=1;i<lines.length;i++){
        if(!lines[i].trim()) continue;
        const f=lines[i].split(";");
        const num=f[idxClient].trim(),
              name=f[idxName].trim();
        const set=new Set();
        for(let j=idxEmp;j<f.length;j++){
          f[j].split("!#!").forEach(e=>e.trim()&&set.add(e.trim()));
        }
        clients[num]={number:num,name,emplois:[...set].sort()};
      }
      populateClientDatalist();
    }
    function populateClientDatalist(){
      const dl=document.getElementById("clientList");
      dl.innerHTML="";
      for(const n in clients){
        const o=document.createElement("option");
        o.value=`${n} - ${clients[n].name}`;
        dl.appendChild(o);
      }
    }

    /* 4) SÉLECTION / DÉSÉLECTION CLIENT */
    document.getElementById("clientInput").addEventListener("change",e=>{
      const parts=e.target.value.split(" - ");
      if(parts.length){
        const num=parts[0].trim();
        selectedClient=clients[num]||null;
        updateEmploiOptions();
        if(selectedClient && selectedClient.emplois.includes("Compagnie")){
          document.getElementById("modeCompagnieContainer").style.display="block";
        } else {
          document.getElementById("modeCompagnieContainer").style.display="none";
          document.getElementById("modeCompagnie").checked=false;
          toggleTableMode(false);
        }
        document.getElementById("printOption").checked=true;
      }
    });
    document.getElementById("clearClient").addEventListener("click",()=>{
      document.getElementById("clientInput").value="";
      selectedClient=null;
      updateEmploiOptions();
    });

    /* 5) MISE À JOUR DES OPTIONS D'EMPLOI */
    function updateEmploiOptions(){
      document.querySelectorAll("select[name$='_emploi']").forEach(sel=>{
        const cur=sel.value; sel.innerHTML="";
        const add=v=>{
          const o=document.createElement("option");
          o.value=v; o.textContent=v;
          sel.appendChild(o);
        };
        add("");
        if(selectedClient) selectedClient.emplois.forEach(add);
        if([...sel.options].some(o=>o.value===cur)) sel.value=cur;
      });
    }

    /* 6) MODE COMPAGNIE */
    document.getElementById("modeCompagnie")
            .addEventListener("change", e=> toggleTableMode(e.target.checked));
    function toggleTableMode(isComp){
      if(isComp){
        document.getElementById("defaultTableContainer").style.display="none";
        document.getElementById("compagnieTableContainer").style.display="block";
        generateCompagnieRows(compagnieRowCount);
      } else {
        document.getElementById("compagnieTableContainer").style.display="none";
        document.getElementById("defaultTableContainer").style.display="block";
        generateDefaultRows(defaultRowCount);
        updateEmploiOptions();
      }
    }

    /* 7) GÉNÉRATION DES LIGNES */
    const moisOptions=`<option value=""></option>
      <option value="01- JANVIER">01- JANVIER</option>…<option value="12- DÉCEMBRE">12- DÉCEMBRE</option>`,
          mkJourOptions=()=>{
            let s='<option value=""></option>';
            for(let d=1; d<=31; d++){
              const dd=String(d).padStart(2,"0");
              s+=`<option value="${dd}">${dd}</option>`;
            }
            return s;
          };

    function defaultRow(i){ return `
      <tr>
        <td><input type="text" name="row${i}_ref"></td>
        <td><input type="text" name="row${i}_nom" required></td>
        <td><input type="text" name="row${i}_prenom" required></td>
        <td>
          <select name="row${i}_sexe" required>
            <option value=""></option><option value="M">M</option>
            <option value="F">F</option><option value="X">X</option>
          </select>
        </td>
        <td><input type="text" name="row${i}_annee" placeholder="YYYY" style="width:60px;" required></td>
        <td><select name="row${i}_mois"  required>${moisOptions}</select></td>
        <td><select name="row${i}_jour"  required>${mkJourOptions()}</select></td>
        <td><select name="row${i}_emploi" required><option value=""></option></select></td>
        <td><input type="text" name="row${i}_adresse"></td>
        <td><input type="text" name="row${i}_app" style="width:60px;"></td>
        <td><input type="text" name="row${i}_ville"></td>
        <td><input type="text" name="row${i}_code_postal" style="width:80px;"></td>
        <td><input type="text" name="row${i}_numero_permis" style="width:15ch;"></td>
        <td><input type="text" name="row${i}_notes"></td>
      </tr>`;}

    function compRow(i){ return `
      <tr>
        <td><input type="text" name="comp_row${i}_ref"></td>
        <td><input type="text" name="comp_row${i}_firme"></td>
        <td><input type="text" name="comp_row${i}_matricule"></td>
        <!-- on ne demande pas nom/prénom/sexe/ddn en UI -->
        <td><!-- NOM vide --></td>
        <td><!-- PRÉNOM vide --></td>
        <td><!-- SEXE vide --></td>
        <td><!-- DDN vide --></td>
        <td><input type="text" name="comp_row${i}_emploi" value="COMPAGNIE" readonly style="background:#eee;"></td>
        <td><input type="text" name="comp_row${i}_adresse"></td>
        <td><input type="text" name="comp_row${i}_app" style="width:60px;"></td>
        <td><input type="text" name="comp_row${i}_ville"></td>
        <td><input type="text" name="comp_row${i}_code_postal" style="width:80px;"></td>
        <td><input type="text" name="comp_row${i}_numero_permis" style="width:15ch;"></td>
        <td><input type="text" name="comp_row${i}_notes"></td>
      </tr>`;}

    function generateDefaultRows(n=10){
      defaultRowCount=n;
      const tb=document.querySelector("#defaultTableContainer tbody");
      tb.innerHTML="";
      for(let i=0;i<n;i++) tb.insertAdjacentHTML("beforeend", defaultRow(i));
    }
    function generateCompagnieRows(n=10){
      compagnieRowCount=n;
      const tb=document.querySelector("#compagnieTableContainer tbody");
      tb.innerHTML="";
      for(let i=0;i<n;i++) tb.insertAdjacentHTML("beforeend", compRow(i));
    }
    generateDefaultRows();

    /* 8) BOUTON « Ajouter ligne » */
    document.getElementById("addRow").addEventListener("click", ()=>{
      if(document.getElementById("defaultTableContainer").style.display!=="none"){
        const tb=document.querySelector("#defaultTableContainer tbody"),
              i=tb.rows.length;
        tb.insertAdjacentHTML("beforeend", defaultRow(i));
        updateEmploiOptions();
      } else {
        const tb=document.querySelector("#compagnieTableContainer tbody"),
              i=tb.rows.length;
        tb.insertAdjacentHTML("beforeend", compRow(i));
      }
    });

    /* 9) FORMATAGE CP & MAJUSCULES */
    document.addEventListener("input", e=>{
      if(e.target.name?.endsWith("_code_postal")){
        let v=e.target.value.toUpperCase().replace(/\s+/g,"");
        if(v.length>3) v=v.slice(0,3)+" "+v.slice(3);
        e.target.value=v.slice(0,7);
      }
      if(e.target.tagName==="INPUT" && e.target.type==="text"){
        e.target.value=e.target.value.toUpperCase();
      }
    });

    /* 10) EXPORT CSV */
    function clearErrors(){
      document.querySelectorAll(".error").forEach(el=>el.classList.remove("error"));
    }
    document.getElementById("saveButton").addEventListener("click", ()=>{
      clearErrors();
      const now=new Date(),
            pad=n=>String(n).padStart(2,"0"),
            ts=`${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;
      let rows=[], csvContent="", filename="";

      if(document.getElementById("modeCompagnie").checked){
        /* MODE COMPAGNIE */
        const tb=document.querySelector("#compagnieTableContainer tbody");
        for(let i=0;i<tb.rows.length;i++){
          const row={
            ref         :document.getElementsByName(`comp_row${i}_ref`)[0].value.trim(),
            firme       :document.getElementsByName(`comp_row${i}_firme`)[0].value.trim(),
            matricule   :document.getElementsByName(`comp_row${i}_matricule`)[0].value.trim(),
            emploi      :"COMPAGNIE",
            adresse     :document.getElementsByName(`comp_row${i}_adresse`)[0].value.trim(),
            app         :document.getElementsByName(`comp_row${i}_app`)[0].value.trim(),
            ville       :document.getElementsByName(`comp_row${i}_ville`)[0].value.trim(),
            code_postal :document.getElementsByName(`comp_row${i}_code_postal`)[0].value.trim(),
            numero_permis:document.getElementsByName(`comp_row${i}_numero_permis`)[0].value.trim(),
            notes       :document.getElementsByName(`comp_row${i}_notes`)[0].value.trim()
          };
          if(Object.values(row).every(v=>v==="")) continue;
          rows.push(row);
        }
        if(rows.length===0){ alert("Aucune donnée saisie."); return; }

        const headers=[
          "NUMERO_REFERENCE","FIRME","MATRICULE",
          "NOM","PRENOM","SEXE","DDN",
          "EMPLOI","ADRESSE","APP","VILLE",
          "CODE_POSTAL","NUMERO_PERMIS","NOTES"
        ];
        csvContent = headers.join(";") + "\n";
        rows.forEach(r=>{
          csvContent += [
            r.ref, r.firme, r.matricule,
            "", "", "", "",
            r.emploi, r.adresse, r.app, r.ville,
            r.code_postal, r.numero_permis, r.notes
          ].join(";") + "\n";
        });

        filename = `${selectedClient.number}-${selectedClient.name.replace(/ /g,"")}_Compagnie_${ts}.csv`;

      } else {
        /* MODE PAR DÉFAUT */
        const tb=document.querySelector("#defaultTableContainer tbody");
        let valid=true;
        for(let i=0;i<tb.rows.length;i++){
          const r={
            ref          :document.getElementsByName(`row${i}_ref`)[0].value.trim(),
            nom          :document.getElementsByName(`row${i}_nom`)[0].value.trim(),
            prenom       :document.getElementsByName(`row${i}_prenom`)[0].value.trim(),
            sexe         :document.getElementsByName(`row${i}_sexe`)[0].value.trim(),
            annee        :document.getElementsByName(`row${i}_annee`)[0].value.trim(),
            mois         :document.getElementsByName(`row${i}_mois`)[0].value.trim(),
            jour         :document.getElementsByName(`row${i}_jour`)[0].value.trim(),
            emploi       :document.getElementsByName(`row${i}_emploi`)[0].value.trim(),
            adresse      :document.getElementsByName(`row${i}_adresse`)[0].value.trim(),
            app          :document.getElementsByName(`row${i}_app`)[0].value.trim(),
            ville        :document.getElementsByName(`row${i}_ville`)[0].value.trim(),
            code_postal  :document.getElementsByName(`row${i}_code_postal`)[0].value.trim(),
            numero_permis:document.getElementsByName(`row${i}_numero_permis`)[0].value.trim(),
            notes        :document.getElementsByName(`row${i}_notes`)[0].value.trim()
          };
          if(Object.values(r).every(v=>v==="")) continue;

          /* Validation minimale */
          const markErr=name=>{ document.getElementsByName(name)[0].classList.add("error"); valid=false; };
          if(!r.nom)    markErr(`row${i}_nom`);
          if(!r.prenom) markErr(`row${i}_prenom`);
          if(!r.sexe)   markErr(`row${i}_sexe`);
          if(!r.annee)  markErr(`row${i}_annee`);
          if(!r.mois)   markErr(`row${i}_mois`);
          if(!r.jour)   markErr(`row${i}_jour`);
          if(!r.emploi) markErr(`row${i}_emploi`);

          /* Format CP */
          let cp=r.code_postal.toUpperCase().replace(/\s+/g,"");
          if(cp.length===6) cp=cp.slice(0,3)+" "+cp.slice(3);
          r.code_postal = cp;

          /* Date de naissance & âge */
          let ddn="";
          if(r.annee&&r.mois&&r.jour){
            const mo= parseInt(r.mois.substr(0,2)),
                  birth=new Date(parseInt(r.annee),mo-1,parseInt(r.jour)),
                  today=new Date();
            let age=today.getFullYear()-birth.getFullYear();
            const mDiff=today.getMonth()-birth.getMonth();
            if(mDiff<0||(mDiff===0&&today.getDate()<birth.getDate())) age--;
            if(age<16||age>100){
              ["annee","mois","jour"].forEach(c=>document.getElementsByName(`row${i}_${c}`)[0].classList.add("error"));
              alert("Erreur : âge doit être entre 16 et 100 ans.");
              return;
            }
            ddn=`${r.annee}-${String(mo).padStart(2,"0")}-${r.jour}`;
          }
          r.ddn=ddn;
          rows.push(r);
        }
        if(!valid){ alert("Veuillez remplir les champs obligatoires."); return; }
        if(rows.length===0){ alert("Aucune donnée saisie."); return; }

        const headers=[
          "NUMERO_REFERENCE","NOM","PRENOM","SEXE","DDN",
          "EMPLOI","ADRESSE","APP","VILLE","CODE_POSTAL","NUMERO_PERMIS","NOTES"
        ];
        csvContent = headers.join(";") + "\n";
        rows.forEach(r=>{
          csvContent += [
            r.ref,r.nom,r.prenom,r.sexe,r.ddn,
            r.emploi,r.adresse,r.app,r.ville,r.code_postal,r.numero_permis,r.notes
          ].join(";")+"\n";
        });

        filename = `${selectedClient.number}-${selectedClient.name.replace(/ /g,"")}_${ts}.csv`;
      }

      /* téléchargement */
      const blob=new Blob(["\uFEFF"+csvContent],{type:"text/csv;charset=windows-1252;"});
      const url=URL.createObjectURL(blob), a=document.createElement("a");
      a.href=url; a.download=filename; document.body.appendChild(a);
      a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      alert("CSV généré et téléchargé.");
    });

    /* 11) RÉINITIALISATION & LIGNES */
    document.getElementById("resetButton").addEventListener("click", ()=>{
      document.getElementById("data-form").reset();
      clearErrors();
      document.getElementById("compagnieTableContainer").style.display="none";
      document.getElementById("defaultTableContainer").style.display="block";
      document.getElementById("modeCompagnie").checked=false;
      generateDefaultRows(defaultRowCount);
      updateEmploiOptions();
    });
    const setRows=n=>{
      if(document.getElementById("modeCompagnie").checked) generateCompagnieRows(n);
      else { generateDefaultRows(n); updateEmploiOptions(); }
    };
    document.getElementById("set1Row").addEventListener("click",()=>setRows(1));
    document.getElementById("set5Rows").addEventListener("click",()=>setRows(5));
    document.getElementById("set10Rows").addEventListener("click",()=>setRows(10));
  </script>

</body>
</html>
